(function(a){function r(e){return(new a.XMLSerializer).serializeToString(e)}function s(e,c){var d=c.reverse();a.jQuery.each(d,function(b,g){e=e.replace(RegExp(a.escapeRegExp(g.placeholder)),"g",g.entity)});return e}function t(a){return a.replace(/"/g,'\\"').replace(/\t/g,"\\t").replace(/\n/g,"\\n")}function u(e,c,d,b,g,h,p){var f='{"items": [';a.jQuery.each(b,function(a,b){f+='{"item": {"id": '+b+'}, "state": 1}'});f+="]}";e='{"title": "'+d+'", "description": "'+d+'", "xml": "'+t(s(r(e),c))+'", "locale": "en-US", "tags": '+
f+', "configuredParameters": ["title", "description", "xml", "locale", "tags"]}';a.jQuery.ajax({type:"POST",url:"http://"+g.PressGangHost+":8080/pressgang-ccms/rest/1/topic/createormatch/json?message=Initial+Topic+Creation&flag=2&userId=89",data:e,contentType:"application/json",dataType:"json",success:function(a){h(a.topic.id,a.matchedExistingTopic)},error:function(){p("Connection Error","An error occurred while uploading the revision history topic.")}})}var k=new a.QNAZipModel;a.QNAStart=(new a.QNAStep).setTitle("Select the ZIP file to import").setIntro("Select the ZIP file that contains the valid Publican book that you wish to import into PressGang CCMS.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.SINGLE_FILE).setIntro("Publican ZIP File").setName("ZipFile")])]).setProcessStep(function(e,
c,d,b){b.ZipFile?k.getCachedEntries(b.ZipFile,function(b){var h=!1;a.angular.forEach(b,function(a,b){if("publican.cfg"===a.filename)return h=!0,!1});h?e(null):c("Error","The ZIP file did not contain a publican.cfg file.")},function(a){c("Error","Could not process the ZIP file!")}):c("Please select a file","You need to select a file before continuing.")}).setNextStep(function(a){a(v)});var v=(new a.QNAStep).setTitle("Select the main XML file").setIntro("Select the main XML file from the ZIP archive. Publican conventions mean the file should be named after the book title in the Book_Info.xml file. This import tool will attempt to read the Book_Info.xml file to find the book title, and from that select the main XML file. You only need to make a manual selection if the import tool could not find the main XML file, or if you want to override the default selection.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.LISTBOX).setName("MainXMLFile").setOptions(function(e,
c,d,b){k.getCachedEntries(b.ZipFile,function(b){var c=[];a.angular.forEach(b,function(a,b){/^.*?\.xml$/.test(a.filename)&&c.push(a.filename)});e(c)})}).setValue(function(e,c,d,b){k.getCachedEntries(b.ZipFile,function(b){a.angular.forEach(b,function(c,d){if(/^en-US\/Book_Info\.xml$/.test(c.filename))return k.getTextFromFile(c,function(c){if(c=/<title>(.*?)<\/title>/.exec(c)){var d="en-US/"+c[1].replace(/ /g,"_")+".xml";a.angular.forEach(b,function(a,b){a.filename===d&&e(d)})}}),!1})});e(null)})])]).setNextStep(function(a){a(w)}),
w=(new a.QNAStep).setTitle("Create or overwrite a content spec?").setIntro("This wizard can create a new content specification, or overwrite the contents of an existing one. You will usually want to create a new content specification, but if you are reimporting a book and want to overwrite the previously imported content spec, select the overwrite option.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.RADIO_BUTTONS).setIntro(["Create a new content spec","Overwrite an existing content spec"]).setName("CreateOrOverwrite").setOptions(["CREATE",
"OVERWRITE"]).setValue("CREATE")])]).setNextStep(function(a,c,d,b){a("CREATE"===b.CreateOrOverwrite?n:x)}),x=(new a.QNAStep).setTitle("Create or overwrite a content spec?").setIntro("This wizard can create a new content specification, or overwrite the contents of an existing one. You will usually want to create a new content specification, but if you are reimporting a book and want to overwrite the previously imported content spec, select the overwrite option.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.TEXTBOX).setIntro("Existing content specification ID").setName("ExistingContentSpecID")])]).setNextStep(function(a){a(n)}),
n=(new a.QNAStep).setTitle("Select the server to import in to").setIntro("You can create the imported content specification on either the production or test PressGang servers. Using the test server is recommended for the first import to check the results before adding the content to the production server.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.RADIO_BUTTONS).setIntro(["Production Server","Test Server"]).setOptions(["skynet.usersys.redhat.com","skynet-dev.usersys.redhat.com"]).setValue("skynet-dev.usersys.redhat.com").setName("PressGangHost")])]).setNextStep(function(a){a(y)}),
y=(new a.QNAStep).setTitle("Importing Publican Book").setOutputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving xi:includes").setName("ResolvedXIIncludes"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding entities in XML").setName("FoundEntities"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding entity definitions").setName("FoundEntityDefinitions"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Removing XML preamble").setName("RemovedXMLPreamble"),
(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Parse as XML").setName("ParsedAsXML"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding revision history").setName("FoundRevisionHistory"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding author group").setName("FoundAuthorGroup"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding and uploading images").setName("FoundImages"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving book structure").setName("ResolvedBookStructure"),
(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving xrefs").setName("ResolvedXrefs"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Uploading content specification").setName("UploadedContentSpecification"),(new a.QNAVariable).setType(a.InputEnum.PROGRESS).setIntro("Progress").setName("UploadProgress").setValue([11,0])])]).setEnterStep(function(e,c,d,b){var g=[],h=[];b.UploadedTopicCount=0;b.MatchedTopicCount=0;var p=function(a){var c="",d;-1!==(d=b.MainXMLFile.lastIndexOf("/"))&&
(c=b.MainXMLFile.substring(0,d));k.getCachedEntries(b.ZipFile,function(d){var q=function(l){if(l>=d.length)b.UploadProgress[1]=3,b.FoundEntityDefinitions=!0,e(),f(a);else{var m=d[l];0===m.filename.indexOf(c)?k.getTextFromFile(m,function(a){for(var b=/<!ENTITY\s+[^\s]+\s+('|").*?('|")\s*>/g,c;c=b.exec(a);)-1===g.indexOf(c[0])&&g.push(c[0]);q(l+1)}):q(l+1)}};q(0)})},f=function(c){c=c.replace(/<\?xml.*?>/g,"");c=c.replace(/<!DOCTYPE[\s\S]*?\[[\s\S]*?\]>/g,"");b.UploadProgress[1]=4;b.RemovedXMLPreamble=
!0;e();c=a.jQuery.parseXML(c);b.UploadProgress[1]=5;b.ParsedAsXML=!0;e();n(c)},n=function(d){(d=d.evaluate("//revhistory",d,null,a.XPathResult.ANY_TYPE,null).iterateNext())&&u(d,h,"Revision History",[598],b,function(a,c){b.RevisionHistoryTopicID=a;b.UploadedTopicCount+=1;c&&(b.MatchedTopicCount+=1);b.UploadProgress[1]=6;b.FoundRevisionHistory=!0;e()},c)};(function(){var d=/<\s*xi:include\s+xmlns:xi\s*=\s*("|')http:\/\/www\.w3\.org\/2001\/XInclude("|')\s+href\s*=\s*("|')(.*?\.xml)("|')\s*\/\s*>/,g=
/^Common_Content/,f=function(a,e,l){var m=d.exec(a);if(m){var h="",n;-1!==(n=e.lastIndexOf("/"))&&(h=e.substring(0,n));if(g.test(m[4]))f(a.replace(m[0],""),e,l);else{var p=h+"/"+m[4];k.getTextFromFileName(b.ZipFile,p,function(b){f(b,p,function(b){f(a.replace(m[0],b),e,l)})},function(a){c(a)})}}else l(a)};k.getTextFromFileName(b.ZipFile,b.MainXMLFile,function(c){f(c,b.MainXMLFile,function(c){b.UploadProgress[1]=1;b.ResolvedXIIncludes=!0;e();for(var d=/&.*?;/,f;f=d.exec(c);){for(var g;-1!==c.indexOf(g=
"#"+Math.floor(1E9*Math.random()+1)+"#"););h.push({placeholder:g,entity:f[0]});c=c.replace(RegExp(a.escapeRegExp(f[0]),"g"),g)}b.UploadProgress[1]=2;b.FoundEntities=!0;e();p(c)})})})()}).setNextStep(function(a,c,d,b){a(the_next_step)})})(this);
