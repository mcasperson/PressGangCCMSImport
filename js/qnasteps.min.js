(function(a){var d=new a.QNAZipModel;a.QNAStart=(new a.QNAStep).setTitle("Select the ZIP file to import").setIntro("Select the ZIP file that contains the valid Publican book that you wish to import into PressGang CCMS.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.SINGLE_FILE).setName("Publican ZIP File").setIntro("ZipFile")])]).setProcessStep(function(e,c,g,b){b.ZipFile?d.getCachedEntries(b.ZipFile,function(b){var l=!1;a.angular.forEach(b,function(a,b){if("publican.cfg"===
a.filename)return l=!0,!1});l?e(null):c("Error","The ZIP file did not contain a publican.cfg file.")},function(a){c("Error","Could not process the ZIP file!")}):c("Please select a file","You need to select a file before continuing.")}).setNextStep(function(a,c,d,b){a(n)});var n=(new a.QNAStep).setTitle("Select the main XML file").setIntro("Select the main XML file from the ZIP archive. Publican conventions mean the file should be named after the book title in the Book_Info.xml file. This import tool will attempt to read the Book_Info.xml file to find the book title, and from that select the main XML file. You only need to make a manual selection if the import tool could not find the main XML file, or if you want to override the default selection.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.LISTBOX).setName("MainXMLFile").setOptions(function(e,
c,g,b){d.getCachedEntries(b.ZipFile,function(b){var c=[];a.angular.forEach(b,function(a,b){/^.*?\.xml$/.test(a.filename)&&c.push(a.filename)});e(c)})}).setValue(function(e,c,g,b){d.getCachedEntries(b.ZipFile,function(b){a.angular.forEach(b,function(c,g){if(/^en-US\/Book_Info\.xml$/.test(c.filename))return d.getTextFromFile(c,function(c){if(c=/<title>(.*?)<\/title>/.exec(c)){var q="en-US/"+c[1].replace(/ /g,"_")+".xml";a.angular.forEach(b,function(a,b){a.filename===q&&e(q)})}}),!1})});e(null)})])]).setNextStep(function(a){a(u)}),
u=(new a.QNAStep).setTitle("Create or overwrite a content spec?").setIntro("This wizard can create a new content specification, or overwrite the contents of an existing one. You will usually want to create a new content specification, but if you are reimporting a book and want to overwrite the previously imported content spec, select the overwrite option.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.RADIO_BUTTONS).setIntro(["Create a new content spec","Overwrite an existing content spec"]).setName("CreateOrOverwrite").setOptions(["CREATE",
"OVERWRITE"]).setValue("CREATE")])]).setNextStep(function(a,c,d,b){a("CREATE"===b.CreateOrOverwrite?m:v)}),v=(new a.QNAStep).setTitle("Create or overwrite a content spec?").setIntro("This wizard can create a new content specification, or overwrite the contents of an existing one. You will usually want to create a new content specification, but if you are reimporting a book and want to overwrite the previously imported content spec, select the overwrite option.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.TEXTBOX).setIntro("Existing content specification ID").setName("ExistingContentSpecID")])]).setNextStep(function(a){a(m)}),
m=(new a.QNAStep).setTitle("Importing Publican Book").setOutputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving xi:includes").setName("ResolvedXIIncludes"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding entities in XML").setName("FoundEntities"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding entity definitions").setName("FoundEntityDefinitions"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Removing XML preamble").setName("RemovedXMLPreamble"),
(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Parse as XML").setName("ParsedAsXML"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding revision history").setName("FoundRevisionHistory"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding author group").setName("FoundAuthorGroup"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding and uploading images").setName("FoundImages"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving book structure").setName("ResolvedBookStructure"),
(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving xrefs").setName("ResolvedXrefs"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Uploading content specification").setName("UploadedContentSpecification"),new a.QNAVariable(a.InputEnum.PROGRESS,"Progress","UploadProgress",null,[11,0])])]).setEnterStep(function(e,c,g,b){var m=[],l=function(a){var c="",f;-1!==(f=b.MainXMLFile.lastIndexOf("/"))&&(c=b.MainXMLFile.substring(0,f));d.getCachedEntries(b.ZipFile,function(r){var p=
function(k){if(k>=r.length)b.UploadProgress[1]=3,b.FoundEntityDefinitions=!0,e(),n(a);else{var h=r[k];0===h.filename.indexOf(c)?d.getTextFromFile(h,function(a){for(var b=/<!ENTITY\s+[^\s]+\s+('|").*?('|")\s*>/g,c;c=b.exec(a);)-1===m.indexOf(c[0])&&m.push(c[0]);p(k+1)}):p(k+1)}};p(0)})},n=function(c){c=c.replace(/<\?xml.*?>/g,"");c=c.replace(/<!DOCTYPE[\s\S]*?\[[\s\S]*?\]>/g,"");b.UploadProgress[1]=4;b.RemovedXMLPreamble=!0;e();var d;a.DOMParser?(new a.DOMParser).parseFromString(c,"text/xml"):(d=new a.ActiveXObject("Microsoft.XMLDOM"),
d.async=!1,d.loadXML(c));b.UploadProgress[1]=5;b.ParsedAsXML=!0;e()};(function(){var g=/<\s*xi:include\s+xmlns:xi\s*=\s*("|')http:\/\/www\.w3\.org\/2001\/XInclude("|')\s+href\s*=\s*("|')(.*?\.xml)("|')\s*\/\s*>/,m=/^Common_Content/,f=function(a,e,k){var h=g.exec(a);if(h){var s="",t;-1!==(t=e.lastIndexOf("/"))&&(s=e.substring(0,t));if(m.test(h[4]))f(a.replace(h[0],""),e,k);else{var l=s+"/"+h[4];d.getTextFromFileName(b.ZipFile,l,function(b){f(b,l,function(b){f(a.replace(h[0],b),e,k)})},function(a){c(a)})}}else k(a)};
d.getTextFromFileName(b.ZipFile,b.MainXMLFile,function(c){f(c,b.MainXMLFile,function(c){b.UploadProgress[1]=1;b.ResolvedXIIncludes=!0;e();for(var d=/&.*?;/,h=[],g;g=d.exec(c);){for(var f;-1!==c.indexOf(f="#"+Math.floor(1E9*Math.random()+1)+"#"););h.push({placeholder:f,entity:g[0]});c=c.replace(RegExp(a.escapeRegExp(g[0]),"g"),f)}b.UploadProgress[1]=2;b.FoundEntities=!0;e();l(c)})})})()}).setNextStep(function(a,c,d,b){a(the_next_step)})})(this);
