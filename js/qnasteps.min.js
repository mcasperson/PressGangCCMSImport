(function(a){function N(g,d){var e,b=g.split("\n");a.jQuery.each(b,function(b,g){var n=g.split(":");if(2===n.length&&RegExp(a.escapeRegExp(d.trim())).test(n[0].trim()))return e=n[1].trim(),!1});return e}function B(g){return(new a.XMLSerializer).serializeToString(g)}function p(g,d){var e=d.reverse();a.jQuery.each(e,function(b,k){g=g.replace(RegExp(a.escapeRegExp(k.placeholder),"g"),k.entity)});return g}function q(a){a=a.replace(/\n/g," ");return a=a.replace(/\s+/g," ")}function K(a){0===a.indexOf("<chapter>")?
(a=a.replace(/^<chapter>/,"<section>"),a=a.replace(/<\/chapter>$/,"</section>")):0===a.indexOf("<appendix>")?(a=a.replace(/^<appendix>/,"<section>"),a=a.replace(/<\/appendix>$/,"</section>")):0===a.indexOf("<part>")&&(a=a.replace(/^<part>/,"<section>"),a=a.replace(/<\/part>$/,"</section>"));return a}function D(g,d,e,b,k,A,n){var l={xml:K(p(B(g),d).trim()),locale:"en-US",configuredParameters:["xml","locale"]};e&&(l.title=e,l.description=e,l.configuredParameters.push("title"),l.configuredParameters.push("description"));
b&&(l.tags={items:[]},l.configuredParameters.push("tags"),a.jQuery.each(b,function(a,b){l.tags.items.push({item:{id:b},state:1})}));a.jQuery.ajax({type:"POST",url:"http://"+k.PressGangHost+":8080/pressgang-ccms/rest/1/topic/createormatch/json?message=Initial+Topic+Creation&flag=2&userId=89",data:JSON.stringify(l),contentType:"application/json",dataType:"json",success:function(a){A(a)},error:function(){n("Connection Error","An error occurred while uploading the topic.")}})}function O(g,d,e,b){a.jQuery.ajax({type:"POST",
url:"http://"+d.PressGangHost+":8080/pressgang-ccms/rest/1/minhashsimilar/get/json?threshold=0.6&expand=%7B%22branches%22%3A%5B%7B%22trunk%22%3A%7B%22name%22%3A%20%22topics%22%7D%7D%5D%7D",data:g,contentType:"application/xml",dataType:"json",success:function(a){e(a)},error:function(){b("Connection Error","An error occurred while getting similar topics.")}})}var s=new a.QNAZipModel;a.QNAStart=(new a.QNAStep).setTitle("Select the ZIP file to import").setIntro("Select the ZIP file that contains the valid Publican book that you wish to import into PressGang CCMS.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.SINGLE_FILE).setIntro("Publican ZIP File").setName("ZipFile")])]).setProcessStep(function(g,
d,e,b){b.ZipFile?s.getCachedEntries(b.ZipFile,function(b){var e=!1;a.angular.forEach(b,function(a,b){if("publican.cfg"===a.filename)return e=!0,!1});e?g(null):d("Error","The ZIP file did not contain a publican.cfg file.")},function(a){d("Error","Could not process the ZIP file!")}):d("Please select a file","You need to select a file before continuing.")}).setNextStep(function(a){a(E)});var E=(new a.QNAStep).setTitle("Select the main XML file").setIntro("Select the main XML file from the ZIP archive. Publican conventions mean the file should be named after the book title in the Book_Info.xml file. This import tool will attempt to read the Book_Info.xml file to find the book title, and from that select the main XML file. You only need to make a manual selection if the import tool could not find the main XML file, or if you want to override the default selection.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.LISTBOX).setName("MainXMLFile").setOptions(function(g,
d,e,b){s.getCachedEntries(b.ZipFile,function(b){var d=[];a.angular.forEach(b,function(a,b){/^.*?\.xml$/.test(a.filename)&&d.push(a.filename)});g(d)})}).setValue(function(g,d,e,b){s.getCachedEntries(b.ZipFile,function(b){a.angular.forEach(b,function(d,e){if(/^en-US\/Book_Info\.xml$/.test(d.filename))return s.getTextFromFile(d,function(d){if(d=/<title>(.*?)<\/title>/.exec(d)){var e="en-US/"+d[1].replace(/ /g,"_")+".xml";a.angular.forEach(b,function(a,b){a.filename===e&&g(e)})}}),!1})});g(null)})])]).setNextStep(function(a){a(F)}),
F=(new a.QNAStep).setTitle("Create or overwrite a content spec?").setIntro("This wizard can create a new content specification, or overwrite the contents of an existing one. You will usually want to create a new content specification, but if you are reimporting a book and want to overwrite the previously imported content spec, select the overwrite option.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.RADIO_BUTTONS).setIntro(["Create a new content spec","Overwrite an existing content spec"]).setName("CreateOrOverwrite").setOptions(["CREATE",
"OVERWRITE"]).setValue("CREATE")])]).setNextStep(function(a,d,e,b){a("CREATE"===b.CreateOrOverwrite?C:G)}),G=(new a.QNAStep).setTitle("Specify the ID of the content specification to overwrite").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.TEXTBOX).setIntro("Existing content specification ID").setName("ExistingContentSpecID")])]).setProcessStep(function(a,d,e,b){/\d+/.test(b.ExistingContentSpecID)?a(null):d("Invalid Content Specification ID","You need to enter a valid content specification id. The ID is a sequence of numbers, like 12321.")}).setNextStep(function(a){a(C)}),
C=(new a.QNAStep).setTitle("Select the server to import in to").setIntro("You can create the imported content specification on either the production or test PressGang servers. Using the test server is recommended for the first import to check the results before adding the content to the production server.").setInputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.RADIO_BUTTONS).setIntro(["Production Server","Test Server"]).setOptions(["skynet.usersys.redhat.com","skynet-dev.usersys.redhat.com"]).setValue("skynet-dev.usersys.redhat.com").setName("PressGangHost")])]).setNextStep(function(a){a(H)}),
H=(new a.QNAStep).setTitle("Importing Publican Book").setOutputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving xi:includes").setName("ResolvedXIIncludes"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding entities in XML").setName("FoundEntities"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding entity definitions").setName("FoundEntityDefinitions"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Removing XML preamble").setName("RemovedXMLPreamble"),
(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Parse as XML").setName("ParsedAsXML"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding book info").setName("FoundBookInfo"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding revision history").setName("FoundRevisionHistory"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding author group").setName("FoundAuthorGroup"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding abstract").setName("FoundAbstract"),
(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Finding and uploading images").setName("FoundImages"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving book structure").setName("ResolvedBookStructure"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Resolving xrefs").setName("ResolvedXrefs"),(new a.QNAVariable).setType(a.InputEnum.CHECKBOX).setIntro("Uploading content specification").setName("UploadedContentSpecification"),(new a.QNAVariable).setType(a.InputEnum.PLAIN_TEXT).setIntro("Topics Created / Topics Reused").setName("NewTopicsCreated"),
(new a.QNAVariable).setType(a.InputEnum.PLAIN_TEXT).setIntro("Images Created / Images Reused").setName("NewImagesCreated"),(new a.QNAVariable).setType(a.InputEnum.PROGRESS).setIntro("Progress").setName("UploadProgress").setValue([13,0])])]).setEnterStep(function(g,d,e,b){var k=[];b.UploadedTopicCount=0;b.MatchedTopicCount=0;b.UploadedImageCount=0;b.MatchedImageCount=0;var A=function(f){for(var d=[],c=/&.*?;/,h;h=c.exec(f);){for(var m;-1!==f.indexOf(m="#"+Math.floor(1E9*Math.random()+1)+"#"););d.push({placeholder:m,
entity:h[0]});f=f.replace(RegExp(a.escapeRegExp(h[0]),"g"),m)}b.UploadProgress[1]=2;b.FoundEntities=!0;g();return{xml:f,replacements:d}},n=function(a){var d=[],c="",h;-1!==(h=b.MainXMLFile.lastIndexOf("/"))&&(c=b.MainXMLFile.substring(0,h));s.getCachedEntries(b.ZipFile,function(m){var h=function(e){if(e>=m.length)b.UploadProgress[1]=3,b.FoundEntityDefinitions=!0,g(),l(a,d);else{var k=m[e];0===k.filename.indexOf(c)?s.getTextFromFile(k,function(a){for(var b=/<!ENTITY\s+[^\s]+\s+".*?"\s*>/g,f=/<!ENTITY\s+[^\s]+\s+'.*?'\s*>/g,
c;c=b.exec(a);)-1===d.indexOf(c[0])&&d.push(c[0]);for(;c=f.exec(a);)-1===d.indexOf(c[0])&&d.push(c[0]);h(e+1)}):h(e+1)}};h(0)})},l=function(f,d){f=f.replace(/<\?xml.*?>/g,"");f=f.replace(/<!DOCTYPE[\s\S]*?\[[\s\S]*?\]>/g,"");b.UploadProgress[1]=4;b.RemovedXMLPreamble=!0;g();var c=a.jQuery.parseXML(f);b.UploadProgress[1]=5;b.ParsedAsXML=!0;g();C(c,d)},C=function(f,e){var c=[],h=f.evaluate("/*/bookinfo",f,null,a.XPathResult.ANY_TYPE,null).iterateNext();if(h){var m=f.evaluate("title",h,null,a.XPathResult.ANY_TYPE,
null).iterateNext(),y=f.evaluate("subtitle",h,null,a.XPathResult.ANY_TYPE,null).iterateNext(),v=f.evaluate("edition",h,null,a.XPathResult.ANY_TYPE,null).iterateNext(),L=f.evaluate("pubsnumber",h,null,a.XPathResult.ANY_TYPE,null).iterateNext(),x=f.evaluate("productname",h,null,a.XPathResult.ANY_TYPE,null).iterateNext(),h=f.evaluate("productnumber",h,null,a.XPathResult.ANY_TYPE,null).iterateNext();m&&c.push("Title = "+p(q(m.innerHTML),k));y&&c.push("Subtitle = "+p(q(y.innerHTML),k));v&&c.push("Edition = "+
p(q(v.innerHTML),k));L&&c.push("Pubsnumber = "+p(q(L.innerHTML),k));x&&c.push("Product = "+p(q(x.innerHTML),k));h&&c.push("Version = "+p(q(h.innerHTML),k));c.push("DTD = Docbook 4.5");c.push("Copyright Holder = Red Hat");"book"===f.documentElement.nodeName?c.push("Type = Book"):"article"===f.documentElement.nodeName&&c.push("Type = Article");0!==e.length&&(c.push("Entities = ["),a.jQuery.each(e,function(a,b){c.push(b)}),c.push("]"));s.getTextFromFileName(b.ZipFile,"publican.cfg",function(a){var d=
N(a,"brand");c.push("Brand = "+d);c.push("publican.cfg = [");c.push(a);c.push("]");b.UploadProgress[1]=6;b.FoundBookInfo=!0;g();E(f,c)},d)}else d("Invalid content","The <bookinfo> element could not be found")},E=function(f,e){var c=f.evaluate("//revhistory",f,null,a.XPathResult.ANY_TYPE,null).iterateNext(),h=function(a,c){b.UploadProgress[1]=7;b.FoundRevisionHistory=!0;g();F(a,c)};c?D(c,k,"Revision History",[598],b,function(a){b.RevisionHistoryTopicID=a.topic.id;b.UploadedTopicCount+=1;a.matchedExistingTopic&&
(b.MatchedTopicCount+=1);b.NewTopicsCreated=b.UploadedTopicCount-b.MatchedTopicCount+" / "+b.MatchedTopicCount;e.push("Revision History = ["+a.topic.id+"]");h(f,e)},d):h(f,e)},F=function(f,e){var c=f.evaluate("//authorgroup",f,null,a.XPathResult.ANY_TYPE,null).iterateNext(),h=function(a,c){b.UploadProgress[1]=8;b.FoundAuthorGroup=!0;g();G(a,c)};c?D(c,k,"Author Group",[664],b,function(a){b.AuthorGroupTopicID=a.topic.id;b.UploadedTopicCount+=1;a.matchedExistingTopic&&(b.MatchedTopicCount+=1);b.NewTopicsCreated=
b.UploadedTopicCount-b.MatchedTopicCount+" / "+b.MatchedTopicCount;e.push("Author Group = ["+a.topic.id+"]");h(f,e)},d):h(f,e)},G=function(f,e){var c=f.evaluate("//bookinfo/abstract",f,null,a.XPathResult.ANY_TYPE,null).iterateNext(),h=function(a,c){b.UploadProgress[1]=9;b.FoundAbstract=!0;g();H(a,c)};c?D(c,k,"Abstract",[692],b,function(a){b.AbstractID=a.topic.id;b.UploadedTopicCount+=1;a.matchedExistingTopic&&(b.MatchedTopicCount+=1);b.NewTopicsCreated=b.UploadedTopicCount-b.MatchedTopicCount+" / "+
b.MatchedTopicCount;e.push("Abstract = ["+a.topic.id+"]");h(f,e)},d):h(f,e)},H=function(f,d){var c=new a.TopicGraph,e=["part","chapter","appendix","section"],m=[],y=function(a){a.hasAttribute("id")&&a.removeAttribute("id");return a},v=function(b,g,l){a.jQuery.each(b.childNodes,function(b,t){if(-1!==e.indexOf(t.nodeName)){var w=t.cloneNode(!0),u=f.evaluate("/title",w,null,a.XPathResult.ANY_TYPE,null).iterateNext();if(u){var r=p(q(u.innerHTML),k),I=[];a.jQuery.each(w.childNodes,function(a,b){-1===e.indexOf(b.nodeName)&&
"revhistory"!==b.nodeName||I.push(b)});a.jQuery.each(I,function(a,b){w.removeChild(b)});for(var u=f.evaluate("/@id",w,null,a.XPathResult.ANY_TYPE,null).iterateNext(),z="",M=0;M<2*l;++M)z+=" ";0===I.length?("section"===t.nodeName?d.push(z+r):d.push(z+t.nodeName.substring(0,1).toUpperCase()+t.nodeName.substring(1,t.nodeName.length)+": "+r),r=(new a.TopicGraphNode(c)).setXml(y(w),f).setSpecLine(d.length-1).setTitle(r),u&&r.addXmlId(u.nodeValue),void 0!==g&&null!==g&&r.addXmlId(g.nodeValue),m.push(r)):
(d.push(z+t.nodeName.substring(0,1).toUpperCase()+t.nodeName.substring(1,t.nodeName.length)+": "+r),0!==w.childNodes.length&&(r=(new a.TopicGraphNode(c)).setXml(y(w),f).setSpecLine(d.length-1).setTitle(r),u&&r.addXmlId(u.nodeValue),void 0!==g&&null!==g&&r.addXmlId(g.nodeValue),u=void 0,m.push(r)),v(t,u,l+1))}}})};v(f.documentElement,null,0);b.UploadProgress[1]=11;b.ResolvedBookStructure=!0;g();J(f,d,m,c)},J=function(f,e,c,g){function m(e,g){if(e>=c.length)g();else{var h=c[e];O(B(h.xml),b,function(b){var c=
h.xml.cloneNode(!0);s(x(c,f),q);var d=B(c),d=n(d),d=p(d,k),d=K(d);a.jQuery.each(b.items,function(b,c){var f=A(c.item.xml),e=a.jQuery.parseXML(f.xml);x(e,e);p(n(B(e)),f.replacements)===d&&h.addPGId(c.item.id,c.item.xml)});m(e+1,g)},d)}}function l(){a.jQuery.each(c,function(b,c){var d=[];a.jQuery.each(c.xrefs,function(a,b){-1!==q.indexOf(b)&&d.push(b)});c.pgIds&&a.jQuery.each(c.pgIds,function(a,b){for(var e=/\x3c!--\s*Inject\s*:\s*(\d+)\s*--\x3e/g,f,g=0;f=e.exec(b.originalXML);){if(g>=d.length)throw"There is a mismatch between the xrefs and the injects.";
c.addOutgoingLink(a,d[g],f[1]);++g}})});v()}function v(){function b(){var f;a.jQuery.each(c,function(a,b){if(void 0===b.topicId&&void 0!==b.outgoingLinks)return f=b,!1});return f}function d(){var b;a.jQuery.each(c,function(a,c){if(void 0===c.topicId)return b=c,!1});return b}for(var f;f=b();){var e;a.jQuery.each(f.pgIds,function(a,b){f.resetTestId();var c=[];if(f.isValid(a,c))return e=c,!1});e||(f.resetTestId(),e=f.getGraph());a.jQuery.each(e,function(a,b){b.topicId=void 0===b.testId?-1:b.testId})}for(;f=
d();)f.topicId=void 0!==f.pgIds?f.pgIds[0]:-1;createTopics()}var s=function(b,c){for(var d=f.evaluate("//xref",b,null,a.XPathResult.ANY_TYPE,null),e,g=[];e=d.iterateNext();)if(e.hasAttribute("linkend")){var h=e.getAttribute("linkend");-1!==c.indexOf(h)&&(h=f.createComment("InjectPlaceholder: 0"),g.push({original:e,replacement:h}))}a.jQuery.each(g,function(a,b){b.original.parentNode.replaceChild(b.replacement,b.original)});return b},x=function(b,c){for(var f=c.evaluate("//comment()",b,null,a.XPathResult.ANY_TYPE,
null),d,e=[];d=f.iterateNext();)if(/^\s*Inject\s*:\s*\d+\s*$/.test(d.textContent)){var g=c.createComment("InjectPlaceholder: 0");e.push({original:d,replacement:g})}a.jQuery.each(e,function(a,b){b.original.parentNode.replaceChild(b.replacement,b.original)});return b},n=function(a){return a.replace(/\n/g,"").replace(/\s/g,"")},q=g.getAllTopicOrContainerIDs();m(0,function(){l()})};(function(){var a=/<\s*xi:include\s+xmlns:xi\s*=\s*("|')http:\/\/www\.w3\.org\/2001\/XInclude("|')\s+href\s*=\s*("|')(.*?\.xml)("|')\s*\/\s*>/,
e=/^Common_Content/,c=function(g,m,k){var l=a.exec(g);if(l){var n="",p;-1!==(p=m.lastIndexOf("/"))&&(n=m.substring(0,p));if(e.test(l[4]))c(g.replace(l[0],""),m,k);else{var q=n+"/"+l[4];s.getTextFromFileName(b.ZipFile,q,function(a){c(a,q,function(a){c(g.replace(l[0],a),m,k)})},function(a){d(a)})}}else k(g)};s.getTextFromFileName(b.ZipFile,b.MainXMLFile,function(a){c(a,b.MainXMLFile,function(a){b.UploadProgress[1]=1;b.ResolvedXIIncludes=!0;g();a=A(a);k=a.replacements;a=a.xml;n(a)})})})()}).setNextStep(function(a){a(J)}).setShowNext(!1).setShowPrevious(!1),
J=(new a.QNAStep).setTitle("Import Summary").setOutputs([(new a.QNAVariables).setVariables([(new a.QNAVariable).setType(a.InputEnum.HTML).setIntro("Content Specification ID").setName("ContentSpecIDLink").setValue(function(a,d,e,b){a("<a href='http://"+b.PressGangHost+":8080/pressgang-ccms-ui/#ContentSpecFilteredResultsAndContentSpecView;query;contentSpecIds="+b.ContentSpecID+"'>"+b.ContentSpecID+"</a>")}),(new a.QNAVariable).setType(a.InputEnum.PLAIN_TEXT).setIntro("Topics Created / Topics Reused").setName("NewTopicsCreated"),
(new a.QNAVariable).setType(a.InputEnum.PLAIN_TEXT).setIntro("Images Created / Images Reused").setName("NewImagesCreated")])]).setShowNext(!1).setShowPrevious(!1).setShowRestart(!0)})(this);
